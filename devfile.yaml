schemaVersion: 2.2.0
attributes:
  controller.devfile.io/storage-type: per-workspace
metadata:
  name: todo-app
components:
- name: dev-tools
  container:
    image: registry.redhat.io/ubi8/nodejs-18:latest
    memoryRequest: 512Mi
    memoryLimit: 2Gi
    cpuRequest: 100m
    cpuLimit: 1000m
    mountSources: true
    sourceMapping: /projects
    env:
    - name: PORT
      value: '3000'
    - name: POSTGRES_USER
      value: postgres
    - name: POSTGRES_PASSWORD
      value: password
    - name: POSTGRES_HOST
      value: localhost
    - name: POSTGRES_DB
      value: todoapp
    - name: POSTGRES_PORT
      value: '5432'
    endpoints:
    - name: todo-app
      targetPort: 3000
      exposure: public
      protocol: https
- name: postgres
  container:
    image: registry.redhat.io/rhel8/postgresql-15:latest
    cpuRequest: 100m
    cpuLimit: 500m
    memoryRequest: 256Mi
    memoryLimit: 512Mi
    mountSources: true
    sourceMapping: /projects
    env:
    - name: POSTGRESQL_USER
      value: postgres
    - name: POSTGRESQL_PASSWORD
      value: password
    - name: POSTGRESQL_DATABASE
      value: todoapp
    volumeMounts:
    - name: pgdata
      path: /var/lib/pgsql/data
    endpoints:
    - name: postgres
      targetPort: 5432
      exposure: internal
- volume:
    size: 1Gi
  name: pgdata
commands:
- exec:
    commandLine: npm install
    component: dev-tools
    group:
      kind: build
      isDefault: true
    workingDir: /projects
  id: install-deps
- exec:
    commandLine: npm run init-db
    component: dev-tools
    group:
      kind: build
    label: Initialize Database
    workingDir: /projects
  id: init-db
- exec:
    commandLine: npm run dev
    component: dev-tools
    group:
      kind: run
      isDefault: true
    label: Start Development Server
    workingDir: /projects
  id: dev-mode
- exec:
    commandLine: npm start
    component: dev-tools
    group:
      kind: run
    label: Start Production Server
    workingDir: /projects
  id: start-app
events:
  postStart:
    - install-deps
    - init-db
