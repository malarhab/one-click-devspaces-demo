schemaVersion: 2.2.0
metadata:
  name: secret-phrase-app
  displayName: Secret Phrase Access App
  description: A secure Node.js application with PostgreSQL backend for password-based secret access
  tags:
    - NodeJS
    - Express
    - PostgreSQL
    - Authentication
  attributes:
    controller.devfile.io/storage-type: per-workspace

components:
  # Node.js runtime container
  - name: tools
    container:
      image: quay.io/devfile/universal-developer-image:ubi9-latest
      memoryLimit: 6G
      memoryRequest: 512Mi
      cpuRequest: 1000m
      cpuLimit: 4000m
      mountSources: true
      env:
        - name: NODE_ENV
          value: development
        - name: DB_HOST
          value: postgres
        - name: DB_PORT
          value: "5432"
        - name: DB_NAME
          value: secret_app
        - name: DB_USER
          value: postgres
        - name: DB_PASSWORD
          value: secretpassword
        - name: PORT
          value: "3000"
      endpoints:
        - name: nodejs-app
          targetPort: 3000
          exposure: public
          protocol: http


  # PostgreSQL database container
  - name: postgres
    container:
      image: postgres:15-alpine
      memoryLimit: 1Gi
      env:
        - name: POSTGRES_DB
          value: secret_app
        - name: POSTGRES_USER
          value: postgres
        - name: POSTGRES_PASSWORD
          value: secretpassword
      endpoints:
        - name: postgres
          targetPort: 5432
          exposure: internal
          protocol: tcp

commands:
  # Install dependencies
  - id: install-dependencies
    exec:
      label: Install Dependencies
      component: tools
      workingDir: ${PROJECT_SOURCE}
      commandLine: npm install
      group:
        kind: build
        isDefault: false

  # Initialize database
  - id: init-database
    exec:
      label: Initialize Database
      component: tools
      workingDir: ${PROJECT_SOURCE}
      commandLine: npm run init-db
      group:
        kind: build
        isDefault: false

  # Start the application
  - id: start-app
    exec:
      label: Start Application
      component: tools
      workingDir: ${PROJECT_SOURCE}
      commandLine: npm start
      group:
        kind: run
        isDefault: true

attributes:
  controller.devfile.io/merge-user-defined-env-vars: true 