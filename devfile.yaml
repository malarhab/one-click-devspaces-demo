schemaVersion: 2.2.0
metadata:
  name: secret-phrase-app
  displayName: Secret Phrase Access App
  description: A secure Node.js application with PostgreSQL backend for password-based secret access
  tags:
    - NodeJS
    - Express
    - PostgreSQL
    - Authentication
  attributes:
    controller.devfile.io/storage-type: per-workspace

components:
  # Node.js runtime container
  - name: nodejs
    container:
      image: node:18-alpine
      memoryLimit: 1Gi
      mountSources: true
      sourceMapping: /project
      env:
        - name: NODE_ENV
          value: development
        - name: DB_HOST
          value: postgres
        - name: DB_PORT
          value: "5432"
        - name: DB_NAME
          value: secret_app
        - name: DB_USER
          value: postgres
        - name: DB_PASSWORD
          value: secretpassword
        - name: PORT
          value: "3000"
      endpoints:
        - name: nodejs-app
          targetPort: 3000
          exposure: public
          protocol: http
        - name: nodejs-debug
          targetPort: 9229
          exposure: internal
          protocol: tcp
      volumeMounts:
        - name: npm-cache
          path: /root/.npm
        - name: node-modules
          path: /project/node_modules

  # PostgreSQL database container
  - name: postgres
    container:
      image: postgres:15-alpine
      memoryLimit: 512Mi
      env:
        - name: POSTGRES_DB
          value: secret_app
        - name: POSTGRES_USER
          value: postgres
        - name: POSTGRES_PASSWORD
          value: secretpassword
        - name: PGDATA
          value: /var/lib/postgresql/data/pgdata
      endpoints:
        - name: postgres
          targetPort: 5432
          exposure: internal
          protocol: tcp
      volumeMounts:
        - name: postgres-data
          path: /var/lib/postgresql/data

  # Persistent volumes
  - name: postgres-data
    volume:
      size: 1Gi

  - name: npm-cache
    volume:
      size: 500Mi

  - name: node-modules
    volume:
      size: 500Mi

commands:
  # Install dependencies
  - id: install-dependencies
    exec:
      label: Install Dependencies
      component: nodejs
      workingDir: ${PROJECT_SOURCE}
      commandLine: npm install
      group:
        kind: build
        isDefault: false

  # Initialize database
  - id: init-database
    exec:
      label: Initialize Database
      component: nodejs
      workingDir: ${PROJECT_SOURCE}
      commandLine: npm run init-db
      group:
        kind: build
        isDefault: false


  # Clean install (remove node_modules and reinstall)
  - id: clean-install
    exec:
      label: Clean Install
      component: nodejs
      workingDir: ${PROJECT_SOURCE}
      commandLine: rm -rf node_modules package-lock.json && npm install
      group:
        kind: build
        isDefault: false


events:
  # Post-start events (run after workspace starts)
  postStart:
    - install-dependencies
    - init-database

  # Pre-stop events (run before workspace stops)
  preStop: []

attributes:
  # Configure the development environment
  controller.devfile.io/merge-user-defined-env-vars: true
  
  # Let OpenShift handle security context automatically
  # Removed controller.devfile.io/scc: container-build
  
  # Remove restrictive security context - let OpenShift assign appropriate values
  # pod-overrides:
  #   spec:
  #     securityContext:
  #       runAsUser: 1000
  #       runAsGroup: 1000
  #       fsGroup: 1000 