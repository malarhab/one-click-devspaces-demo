schemaVersion: 2.2.0
metadata:
  name: todo-app

components:
  - name: nodejs
    container:
      image: node:18
      mountSources: true
      sourceMapping: /projects
      endpoints:
        - name: web
          targetPort: 3000
          protocol: http
          exposure: public
      env:
        - name: DATABASE_URL
          value: postgres://postgres:password@postgres:5432/todoapp
        - name: NODE_ENV
          value: development
      workingDir: /projects
      command: ['/bin/sh']
      args: ['-c', 'tail -f /dev/null']

  - name: postgres
    container:
      image: postgres:13
      env:
        - name: POSTGRES_DB
          value: todoapp
        - name: POSTGRES_USER
          value: postgres
        - name: POSTGRES_PASSWORD
          value: password
      endpoints:
        - name: database
          targetPort: 5432
          protocol: tcp
          exposure: internal
      volumeMounts:
        - name: postgres-data
          path: /var/lib/postgresql/data

  - name: postgres-data
    volume:
      size: 1Gi

commands:
  - id: install-deps
    exec:
      component: nodejs
      commandLine: npm install
      workingDir: /projects

  - id: start-dev
    exec:
      component: nodejs
      commandLine: npm run dev
      workingDir: /projects

  - id: init-db
    exec:
      component: nodejs
      commandLine: node init-db.js
      workingDir: /projects

events:
  postStart:
    - install-deps 