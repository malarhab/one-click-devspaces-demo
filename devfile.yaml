schemaVersion: 2.2.0
attributes:
  controller.devfile.io/storage-type: per-workspace
metadata:
  name: todo-app

components:
  - name: nodejs
    container:
      image: node:18
      mountSources: true
      sourceMapping: /projects
      memoryRequest: 512Mi
      memoryLimit: 2Gi
      cpuRequest: 100m
      cpuLimit: 1000m
      endpoints:
        - name: web
          targetPort: 3000
          protocol: http
          exposure: public
      env:
        - name: DATABASE_URL
          value: postgres://postgres:password@postgres:5432/todoapp
        - name: NODE_ENV
          value: development
        - name: POSTGRES_HOST
          value: postgres
        - name: POSTGRES_DB
          value: todoapp
        - name: POSTGRES_USER
          value: postgres
        - name: POSTGRES_PASSWORD
          value: password
      volumeMounts:
        - name: npm-cache
          path: /home/node/.npm

  - name: postgres
    container:
      image: postgres:13
      memoryRequest: 256Mi
      memoryLimit: 1Gi
      cpuRequest: 50m
      cpuLimit: 500m
      env:
        - name: POSTGRES_DB
          value: todoapp
        - name: POSTGRES_USER
          value: postgres
        - name: POSTGRES_PASSWORD
          value: password
      endpoints:
        - name: database
          targetPort: 5432
          protocol: tcp
          exposure: internal
      volumeMounts:
        - name: postgres-data
          path: /var/lib/postgresql/data

  - name: postgres-data
    volume:
      size: 1Gi

  - name: npm-cache
    volume:
      size: 512Mi

commands:
  - id: install-deps
    exec:
      component: nodejs
      commandLine: npm install
      workingDir: /projects
      group:
        kind: build
        isDefault: true

  - id: start-dev
    exec:
      component: nodejs
      commandLine: npm run dev
      workingDir: /projects
      group:
        kind: run
        isDefault: true

  - id: init-db
    exec:
      component: nodejs
      commandLine: node init-db.js
      workingDir: /projects 